import Head from "next/head";
import {
  createAndAddWallet,
  getUserByUsername,
  getWallet,
} from "../../utils/firebase.util";
import Layout from "../../components/layout.component";
import Overlay from "../../components/overlay.component";
import Image from "next/image";
import Button from "../../components/button.component";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import Circle from "../../components/loading-circle.component";
import { useContext, useEffect, useState } from "react";
import UserTokens from "../../components/userTokens.component";
import { WalletData } from "../../utils/fetchers.util";
import { User } from "../../utils/types.util";
import { UserContext } from "../../contexts/user.context";
import { useRouter } from "next/router";

export async function getServerSideProps({ params: { username } }: any) {
  const profileUser = await getUserByUsername(username);
  const { uid, avatar, account_address, account_balance } = profileUser;

  return {
    props: {
      profileUser: { uid, username, avatar, account_address, account_balance },
    },
  };
}

type Props = {
  profileUser: User;
};

export default function UserPage({ profileUser }: Props) {
  const { uid, username, avatar, account_address, account_balance } =
    profileUser;
  const queryClient = useQueryClient();

  const {
    user: { uid: uidClient, username: usernameClient },
  } = useContext(UserContext);

  const router = useRouter();

  const {
    data,
    isFetching,
    isLoading: isWalletLoading,
  } = useQuery<WalletData>(["wallet"], () => getWallet(uid));

  const mutate = useMutation(async () => await createAndAddWallet(uid), {
    onSuccess: () => {
      queryClient.invalidateQueries(["wallet"]);
    },
  });

  useEffect(() => {
    console.log(data);
  }, [data]);

  const isLoading = isWalletLoading || isFetching || mutate.isLoading;

  const UserPreview = () => (
    <div className="w-full flex gap-8">
      <div className="w-32 h-32 relative">
        <Image src={avatar!} alt="avatar" fill />
      </div>
      <div className="flex flex-col gap-6">
        <div>
          <p className="text-xl text-primary-dark">
            Username:
            <span className="ml-4 text-lg text-black font-mono ">
              {username}
            </span>
          </p>
        </div>
        <div>
          {!!data?.account_address && (
            <p className="text-xl text-primary-dark">
              Account address:
              <span className="ml-4 text-lg text-black font-mono ">
                {data!.account_address}
              </span>
            </p>
          )}
        </div>
      </div>
    </div>
  );

  const UserInfo = () => (
    <div className="w-full flex gap-8">
      <div className="w-32 h-32 relative">
        <Image src={avatar!} alt="avatar" fill />
      </div>
      <div className="flex flex-col gap-6">
        <div>
          <p className="text-xl text-primary-dark">
            Username:
            <span className="ml-4 text-lg text-black font-mono ">
              {username}
            </span>
          </p>
        </div>
        {data?.account_address ? (
          <>
            <div>
              <p className="text-xl text-primary-dark">
                Account address:
                <span className="ml-4 text-lg text-black font-mono ">
                  {data!.account_address}
                </span>
              </p>
            </div>
            {usernameClient === username && (
              <div>
                <p className="text-xl text-primary-dark">
                  Account balance:
                  <span className="ml-4 text-lg text-black font-mono ">
                    {data!.account_balance}
                  </span>
                </p>
              </div>
            )}
          </>
        ) : (
          <div className="h-full grid place-content-center">
            <Button className="w-full" onClick={mutate.mutate}>
              Create Wallet
            </Button>
          </div>
        )}
      </div>
    </div>
  );

  return (
    <>
      <Head>
        <title>User</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Layout>
        <Overlay>
          <section className="card mt-12 h-[150px]">
            {isLoading ? (
              <div className="h-full grid place-items-center">
                <Circle className="text-contrast h-16 w-16" />
              </div>
            ) : usernameClient === username ? (
              <UserInfo />
            ) : (
              <UserPreview />
            )}
          </section>
          <section className="flex flex-col gap-4 mt-4 items-center mb-8">
            <UserTokens profileUser={profileUser} />
          </section>
        </Overlay>
      </Layout>
    </>
  );
}
